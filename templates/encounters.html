{% extends "base.html" %}

{% block title %}Encounters - Clinic Visit Tracker{% endblock %}
{% block nav_timer %}active{% endblock %}

{% block content %}
<div class="encounters-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>Encounters</h1>
    <div class="auto-start-toggle" style="display: flex; align-items: center; gap: 1rem;">
        <label style="margin: 0; display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="autoStartToggle" checked style="width: 20px; height: 20px; cursor: pointer;">
            <span style="font-size: 1rem;">Auto-start timer after save</span>
        </label>
    </div>
</div>

<!-- Bible Verse Banner -->
<div id="verseBanner" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border-radius: 8px; padding: 1rem 1.5rem; margin-bottom: 1.5rem; font-style: italic; color: var(--text-secondary);">
    <div id="verseText" style="font-size: 1rem; line-height: 1.6;"></div>
</div>

<!-- Success Flash Message -->
<div id="flashMessage" style="display: none; background-color: var(--accent-green); color: white; padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1rem; animation: slideDown 0.3s ease-out;">
    ✓ Visit saved successfully!
</div>

<!-- TIMER SECTION -->
<div class="timer-container" style="margin-bottom: 3rem; border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem;">
    <h2 style="margin-top: 0; margin-bottom: 1.5rem;">Timer Mode</h2>

    <div class="encounter-info" id="encounterInfo">
        <span id="encounterLabel">Ready to start</span>
    </div>

    <div class="timer-display" id="timerDisplay">00:00</div>

    <div class="timer-controls">
        <button class="btn btn-success btn-large" id="startBtn" onclick="startTimer()">Start Visit</button>
        <button class="btn btn-secondary btn-large" id="pauseBtn" onclick="pauseTimer()" style="display: none;">Pause</button>
        <button class="btn btn-primary btn-large" id="resumeBtn" onclick="resumeTimer()" style="display: none;">Resume</button>
        <button class="btn btn-danger btn-large" id="stopBtn" onclick="stopTimer()" style="display: none;">End Visit</button>
    </div>

    <div class="visit-form" id="visitForm" style="display: none;">
        <h3 class="mb-3">Visit Details</h3>

        <!-- Time-based Billing Helper -->
        <div id="timeBasedBilling" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <strong>Visit Duration:</strong> <span id="visitDurationDisplay" style="color: var(--accent-blue); font-size: 1.1rem;">--:--</span>
                    <span style="color: var(--text-secondary); margin-left: 0.5rem; font-size: 0.9rem;">(Time-based billing for sick visits)</span>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="autoSelectBillingCode('established')" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                        Auto-select: Established
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="autoSelectBillingCode('new')" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                        Auto-select: New Patient
                    </button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Billing Codes (click to select)</label>
            <div id="billingCodesContainer" style="background-color: var(--bg-secondary); border-radius: 12px; padding: 1.5rem;">
                <!-- Billing codes will be loaded here -->
            </div>
            <div id="visitTypeIndicator" style="margin-top: 1rem; padding: 0.75rem; border-radius: 8px; display: none;">
                <strong>Visit Type:</strong> <span id="visitTypeText"></span>
            </div>
            <div id="wellVisitWarning" class="alert alert-warning" style="display: none; margin-top: 1rem;">
                ⚠️ Multiple well visit codes selected. Only one well visit code should be used per visit.
            </div>
        </div>

        <div id="customFieldsContainer"></div>

        <div class="form-group">
            <label for="comments">Comments</label>
            <textarea id="comments" placeholder="Notes about this visit..."></textarea>
        </div>

        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn btn-success btn-large" onclick="saveTimerVisit()">Save & Start Next Visit</button>
        </div>
    </div>
</div>

<!-- MANUAL ENTRY SECTION -->
<div class="manual-entry-container" style="border: 2px solid var(--border-color); border-radius: 12px; padding: 2rem;">
    <h2 style="margin-top: 0; margin-bottom: 1.5rem;">Manual Entry Mode</h2>
    <p class="text-muted mb-3">Enter visit data without using the timer. All fields are optional.</p>

    <div class="visit-form">
        <div class="form-row">
            <div class="form-group">
                <label for="manualDate">Date</label>
                <input type="date" id="manualDate">
            </div>
            <div class="form-group">
                <label for="manualStartTime">Start Time (optional)</label>
                <input type="time" id="manualStartTime">
            </div>
            <div class="form-group">
                <label for="manualEndTime">End Time (optional)</label>
                <input type="time" id="manualEndTime">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="manualDuration">Duration (minutes, optional)</label>
                <input type="number" id="manualDuration" min="0" step="1" placeholder="Auto-calculated or manual">
            </div>
        </div>

        <div class="form-group">
            <label>Billing Codes (click to select)</label>
            <div id="manualBillingCodesContainer" style="background-color: var(--bg-secondary); border-radius: 12px; padding: 1.5rem;">
                <!-- Billing codes will be loaded here -->
            </div>
            <div id="manualVisitTypeIndicator" style="margin-top: 1rem; padding: 0.75rem; border-radius: 8px; display: none;">
                <strong>Visit Type:</strong> <span id="manualVisitTypeText"></span>
            </div>
            <div id="manualWellVisitWarning" class="alert alert-warning" style="display: none; margin-top: 1rem;">
                ⚠️ Multiple well visit codes selected. Only one well visit code should be used per visit.
            </div>
        </div>

        <div id="manualCustomFieldsContainer"></div>

        <div class="form-group">
            <label for="manualComments">Comments</label>
            <textarea id="manualComments" placeholder="Notes about this visit..."></textarea>
        </div>

        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn btn-success btn-large" onclick="saveManualVisit()">Save Manual Entry</button>
        </div>
    </div>
</div>

<div id="manualMessage" style="margin-top: 1rem;"></div>

<script>
// TIMER MODE VARIABLES
let timerInterval = null;
let startTime = null;
let pausedTime = 0;
let totalPausedDuration = 0;
let isPaused = false;
let encounterNumber = 0;

// Well visit codes for detection
const WELL_VISIT_CODES = ['99381', '99382', '99383', '99384', '99385', '99391', '99392', '99393', '99394', '99395'];

// Load encounter number from today's visits
async function loadEncounterNumber() {
    const today = new Date().toISOString().split('T')[0];
    const response = await fetch(`/api/daily-visits?date=${today}`);
    const data = await response.json();
    encounterNumber = data.visits.length;
}

// Load billing codes with POS-style buttons (for timer mode)
async function loadBillingCodes() {
    const response = await fetch('/api/wrvu-lookup');
    const wrvuLookup = await response.json();

    const container = document.getElementById('billingCodesContainer');
    container.innerHTML = '';

    // Group codes by category for better organization
    const established = ['99212', '99213', '99214', '99215'];
    const newPatient = ['99202', '99203', '99204', '99205'];
    const wellNew = ['99381', '99382', '99383', '99384', '99385'];
    const wellEst = ['99391', '99392', '99393', '99394', '99395'];
    const modifier = ['25'];

    // Combine sick visits and well visits for compact layout
    const sickVisits = [...established, ...newPatient];
    const wellVisits = [...wellNew, ...wellEst];

    const categories = [
        {title: 'Sick Visits (Established & New)', codes: sickVisits, gridClass: 'billing-buttons-grid-4col'},
        {title: 'Well Visits (New & Established)', codes: wellVisits, gridClass: 'billing-buttons-grid-7col'},
        {title: 'Modifier', codes: modifier, gridClass: 'billing-buttons-grid'}
    ];

    categories.forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'billing-category';

        const categoryTitle = document.createElement('div');
        categoryTitle.className = 'billing-category-title';
        categoryTitle.textContent = category.title;
        categoryDiv.appendChild(categoryTitle);

        const gridDiv = document.createElement('div');
        gridDiv.className = category.gridClass || 'billing-buttons-grid';

        category.codes.forEach(code => {
            if (wrvuLookup[code]) {
                const codeInfo = wrvuLookup[code];
                const button = document.createElement('div');
                button.className = 'billing-btn';
                button.dataset.code = code;

                button.innerHTML = `
                    <div class="billing-btn-code">${code}</div>
                    <div class="billing-btn-desc">${codeInfo.description}</div>
                    <div class="billing-btn-wrvu">${codeInfo.wrvu} wRVU</div>
                `;

                button.onclick = () => toggleBillingCode(button, code);
                gridDiv.appendChild(button);
            }
        });

        categoryDiv.appendChild(gridDiv);
        container.appendChild(categoryDiv);
    });
}

// Load billing codes for manual entry mode
async function loadManualBillingCodes() {
    const response = await fetch('/api/wrvu-lookup');
    const wrvuLookup = await response.json();

    const container = document.getElementById('manualBillingCodesContainer');
    container.innerHTML = '';

    const established = ['99212', '99213', '99214', '99215'];
    const newPatient = ['99202', '99203', '99204', '99205'];
    const wellNew = ['99381', '99382', '99383', '99384', '99385'];
    const wellEst = ['99391', '99392', '99393', '99394', '99395'];
    const modifier = ['25'];

    // Combine sick visits and well visits for compact layout
    const sickVisits = [...established, ...newPatient];
    const wellVisits = [...wellNew, ...wellEst];

    const categories = [
        {title: 'Sick Visits (Established & New)', codes: sickVisits, gridClass: 'billing-buttons-grid-4col'},
        {title: 'Well Visits (New & Established)', codes: wellVisits, gridClass: 'billing-buttons-grid-7col'},
        {title: 'Modifier', codes: modifier, gridClass: 'billing-buttons-grid'}
    ];

    categories.forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'billing-category';

        const categoryTitle = document.createElement('div');
        categoryTitle.className = 'billing-category-title';
        categoryTitle.textContent = category.title;
        categoryDiv.appendChild(categoryTitle);

        const gridDiv = document.createElement('div');
        gridDiv.className = category.gridClass || 'billing-buttons-grid';

        category.codes.forEach(code => {
            if (wrvuLookup[code]) {
                const codeInfo = wrvuLookup[code];
                const button = document.createElement('div');
                button.className = 'billing-btn manual-billing-btn';
                button.dataset.code = code;

                button.innerHTML = `
                    <div class="billing-btn-code">${code}</div>
                    <div class="billing-btn-desc">${codeInfo.description}</div>
                    <div class="billing-btn-wrvu">${codeInfo.wrvu} wRVU</div>
                `;

                button.onclick = () => {
                    button.classList.toggle('selected');
                    updateManualVisitTypeIndicator();
                };
                gridDiv.appendChild(button);
            }
        });

        categoryDiv.appendChild(gridDiv);
        container.appendChild(categoryDiv);
    });
}

// Toggle billing code selection (timer mode)
function toggleBillingCode(button, code) {
    button.classList.toggle('selected');
    updateVisitTypeIndicator();
}

// Update visit type indicator based on selected codes (timer mode)
function updateVisitTypeIndicator() {
    const selectedCodes = Array.from(document.querySelectorAll('#billingCodesContainer .billing-btn.selected')).map(btn => btn.dataset.code);
    const wellVisitCodes = selectedCodes.filter(code => WELL_VISIT_CODES.includes(code));

    // Sick visit codes (established and new patient)
    const sickVisitCodes = ['99212', '99213', '99214', '99215', '99202', '99203', '99204', '99205'];
    const hasSickCode = selectedCodes.some(code => sickVisitCodes.includes(code));

    const indicator = document.getElementById('visitTypeIndicator');
    const visitTypeText = document.getElementById('visitTypeText');
    const warning = document.getElementById('wellVisitWarning');

    // Auto-activate 25 modifier if both well visit and sick visit codes are present
    const modifier25Button = document.querySelector('#billingCodesContainer .billing-btn[data-code="25"]');
    if (modifier25Button) {
        if (wellVisitCodes.length > 0 && hasSickCode) {
            // Both well and sick codes present - auto-select 25 modifier
            if (!modifier25Button.classList.contains('selected')) {
                modifier25Button.classList.add('selected');
            }
        } else {
            // Either well or sick codes missing - deselect 25 modifier
            if (modifier25Button.classList.contains('selected')) {
                modifier25Button.classList.remove('selected');
            }
        }
    }

    if (selectedCodes.length > 0) {
        indicator.style.display = 'block';

        if (wellVisitCodes.length > 0) {
            visitTypeText.textContent = 'Well Visit';
            visitTypeText.style.color = 'var(--accent-green)';

            if (wellVisitCodes.length > 1) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        } else {
            visitTypeText.textContent = 'Sick Visit';
            visitTypeText.style.color = 'var(--accent-blue)';
            warning.style.display = 'none';
        }
    } else {
        indicator.style.display = 'none';
        warning.style.display = 'none';
    }
}

// Update visit type indicator for manual entry mode
function updateManualVisitTypeIndicator() {
    const selectedCodes = Array.from(document.querySelectorAll('#manualBillingCodesContainer .billing-btn.selected')).map(btn => btn.dataset.code);
    const wellVisitCodes = selectedCodes.filter(code => WELL_VISIT_CODES.includes(code));

    // Sick visit codes (established and new patient)
    const sickVisitCodes = ['99212', '99213', '99214', '99215', '99202', '99203', '99204', '99205'];
    const hasSickCode = selectedCodes.some(code => sickVisitCodes.includes(code));

    const indicator = document.getElementById('manualVisitTypeIndicator');
    const visitTypeText = document.getElementById('manualVisitTypeText');
    const warning = document.getElementById('manualWellVisitWarning');

    // Auto-activate 25 modifier if both well visit and sick visit codes are present
    const modifier25Button = document.querySelector('#manualBillingCodesContainer .billing-btn[data-code="25"]');
    if (modifier25Button) {
        if (wellVisitCodes.length > 0 && hasSickCode) {
            // Both well and sick codes present - auto-select 25 modifier
            if (!modifier25Button.classList.contains('selected')) {
                modifier25Button.classList.add('selected');
            }
        } else {
            // Either well or sick codes missing - deselect 25 modifier
            if (modifier25Button.classList.contains('selected')) {
                modifier25Button.classList.remove('selected');
            }
        }
    }

    if (selectedCodes.length > 0) {
        indicator.style.display = 'block';

        if (wellVisitCodes.length > 0) {
            visitTypeText.textContent = 'Well Visit';
            visitTypeText.style.color = 'var(--accent-green)';

            if (wellVisitCodes.length > 1) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        } else {
            visitTypeText.textContent = 'Sick Visit';
            visitTypeText.style.color = 'var(--accent-blue)';
            warning.style.display = 'none';
        }
    } else {
        indicator.style.display = 'none';
        warning.style.display = 'none';
    }
}

// Load custom fields (timer mode)
async function loadCustomFields() {
    const response = await fetch('/api/custom-fields');
    const fields = await response.json();

    const container = document.getElementById('customFieldsContainer');
    container.innerHTML = '';

    if (fields.length > 0) {
        const row = document.createElement('div');
        row.className = 'form-row';

        fields.forEach(field => {
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';

            const label = document.createElement('label');
            label.textContent = field.field_name;
            formGroup.appendChild(label);

            if (field.field_type === 'dropdown') {
                const select = document.createElement('select');
                select.id = `custom_${field.id}`;
                select.dataset.fieldName = field.field_name;

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select...';
                select.appendChild(defaultOption);

                if (field.options) {
                    field.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option;
                        select.appendChild(opt);
                    });
                }

                formGroup.appendChild(select);
            } else if (field.field_type === 'number') {
                const input = document.createElement('input');
                input.type = 'number';
                input.id = `custom_${field.id}`;
                input.dataset.fieldName = field.field_name;
                formGroup.appendChild(input);
            }

            row.appendChild(formGroup);
        });

        container.appendChild(row);
    }
}

// Load custom fields (manual entry mode)
async function loadManualCustomFields() {
    const response = await fetch('/api/custom-fields');
    const fields = await response.json();

    const container = document.getElementById('manualCustomFieldsContainer');
    container.innerHTML = '';

    if (fields.length > 0) {
        const row = document.createElement('div');
        row.className = 'form-row';

        fields.forEach(field => {
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';

            const label = document.createElement('label');
            label.textContent = field.field_name;
            formGroup.appendChild(label);

            if (field.field_type === 'dropdown') {
                const select = document.createElement('select');
                select.id = `manual_custom_${field.id}`;
                select.dataset.fieldName = field.field_name;

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select...';
                select.appendChild(defaultOption);

                if (field.options) {
                    field.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option;
                        select.appendChild(opt);
                    });
                }

                formGroup.appendChild(select);
            } else if (field.field_type === 'number') {
                const input = document.createElement('input');
                input.type = 'number';
                input.id = `manual_custom_${field.id}`;
                input.dataset.fieldName = field.field_name;
                formGroup.appendChild(input);
            }

            row.appendChild(formGroup);
        });

        container.appendChild(row);
    }
}

// Auto-calculate duration based on start and end times (manual mode)
function calculateDuration() {
    const startTime = document.getElementById('manualStartTime').value;
    const endTime = document.getElementById('manualEndTime').value;

    if (startTime && endTime) {
        const start = new Date(`2000-01-01T${startTime}`);
        const end = new Date(`2000-01-01T${endTime}`);
        const diffMs = end - start;
        const diffMins = Math.round(diffMs / 60000);

        if (diffMins > 0) {
            document.getElementById('manualDuration').value = diffMins;
        }
    }
}

// Add event listeners for auto-calculation
document.addEventListener('DOMContentLoaded', function() {
    const startTimeInput = document.getElementById('manualStartTime');
    const endTimeInput = document.getElementById('manualEndTime');

    if (startTimeInput && endTimeInput) {
        startTimeInput.addEventListener('change', calculateDuration);
        endTimeInput.addEventListener('change', calculateDuration);
    }
});

// TIMER FUNCTIONS
function updateTimerDisplay() {
    const now = Date.now();
    const elapsed = isPaused
        ? pausedTime - startTime - totalPausedDuration
        : now - startTime - totalPausedDuration;

    const seconds = Math.floor(elapsed / 1000);
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;

    const display = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
    document.getElementById('timerDisplay').textContent = display;
}

function startTimer() {
    encounterNumber++;
    startTime = Date.now();
    totalPausedDuration = 0;
    isPaused = false;

    timerInterval = setInterval(updateTimerDisplay, 100);

    document.getElementById('encounterLabel').textContent = `Encounter #${encounterNumber} - Active`;
    document.getElementById('encounterInfo').innerHTML = `
        <span class="status-indicator status-active"></span>
        <span id="encounterLabel">Encounter #${encounterNumber} - Active</span>
    `;

    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('pauseBtn').style.display = 'inline-block';
    document.getElementById('stopBtn').style.display = 'inline-block';
    document.getElementById('visitForm').style.display = 'none';
}

function pauseTimer() {
    if (!isPaused) {
        isPaused = true;
        pausedTime = Date.now();

        document.getElementById('encounterInfo').innerHTML = `
            <span class="status-indicator status-paused"></span>
            <span id="encounterLabel">Encounter #${encounterNumber} - Paused</span>
        `;

        document.getElementById('pauseBtn').style.display = 'none';
        document.getElementById('resumeBtn').style.display = 'inline-block';
    }
}

function resumeTimer() {
    if (isPaused) {
        totalPausedDuration += Date.now() - pausedTime;
        isPaused = false;

        document.getElementById('encounterInfo').innerHTML = `
            <span class="status-indicator status-active"></span>
            <span id="encounterLabel">Encounter #${encounterNumber} - Active</span>
        `;

        document.getElementById('resumeBtn').style.display = 'none';
        document.getElementById('pauseBtn').style.display = 'inline-block';
    }
}

function stopTimer() {
    clearInterval(timerInterval);

    const endTime = isPaused ? pausedTime : Date.now();
    const activeDuration = Math.floor((endTime - startTime - totalPausedDuration) / 1000);

    document.getElementById('encounterInfo').innerHTML = `
        <span class="status-indicator status-stopped"></span>
        <span id="encounterLabel">Encounter #${encounterNumber} - Completed</span>
    `;

    document.getElementById('pauseBtn').style.display = 'none';
    document.getElementById('resumeBtn').style.display = 'none';
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('visitForm').style.display = 'block';

    // Update visit duration display for time-based billing
    const minutes = Math.floor(activeDuration / 60);
    const seconds = activeDuration % 60;
    document.getElementById('visitDurationDisplay').textContent = `${minutes}:${String(seconds).padStart(2, '0')} (${minutes} min)`;

    // Store the duration for when we save
    window.currentVisitData = {
        startTime: new Date(startTime).toISOString(),
        endTime: new Date(endTime).toISOString(),
        activeDuration: activeDuration
    };
}

// Time-based billing code selection
function autoSelectBillingCode(patientType) {
    if (!window.currentVisitData) {
        alert('No visit data available');
        return;
    }

    // Pause the timer if it's running (not already paused)
    if (!isPaused && timerInterval) {
        pauseTimer();
    }

    const durationMinutes = Math.floor(window.currentVisitData.activeDuration / 60);
    let selectedCode = null;

    // Time-based billing mappings
    if (patientType === 'established') {
        if (durationMinutes >= 10 && durationMinutes <= 19) {
            selectedCode = '99212';
        } else if (durationMinutes >= 20 && durationMinutes <= 29) {
            selectedCode = '99213';
        } else if (durationMinutes >= 30 && durationMinutes <= 39) {
            selectedCode = '99214';
        } else if (durationMinutes >= 40 && durationMinutes <= 54) {
            selectedCode = '99215';
        } else {
            // Default to highest or lowest based on duration
            if (durationMinutes < 10) {
                selectedCode = '99212'; // Minimum
            } else {
                selectedCode = '99215'; // Maximum for 55+ minutes
            }
        }
    } else if (patientType === 'new') {
        if (durationMinutes >= 15 && durationMinutes <= 29) {
            selectedCode = '99202';
        } else if (durationMinutes >= 30 && durationMinutes <= 44) {
            selectedCode = '99203';
        } else if (durationMinutes >= 45 && durationMinutes <= 59) {
            selectedCode = '99204';
        } else if (durationMinutes >= 60 && durationMinutes <= 74) {
            selectedCode = '99205';
        } else {
            // Default to closest match
            if (durationMinutes < 15) {
                selectedCode = '99202'; // Minimum
            } else {
                selectedCode = '99205'; // Maximum for 75+ minutes
            }
        }
    }

    if (selectedCode) {
        // Deselect all sick visit codes (established and new patient codes)
        const sickVisitCodes = ['99212', '99213', '99214', '99215', '99202', '99203', '99204', '99205'];
        document.querySelectorAll('#billingCodesContainer .billing-btn').forEach(button => {
            if (sickVisitCodes.includes(button.dataset.code)) {
                button.classList.remove('selected');
            }
        });

        // Select the calculated code
        const targetButton = document.querySelector(`#billingCodesContainer .billing-btn[data-code="${selectedCode}"]`);
        if (targetButton) {
            targetButton.classList.add('selected');
            updateVisitTypeIndicator();

            // Scroll to the billing codes section so user can see the selection
            targetButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
}

// SAVE FUNCTIONS
async function saveTimerVisit() {
    // Collect selected billing codes from buttons
    const billingCodes = [];
    document.querySelectorAll('#billingCodesContainer .billing-btn.selected').forEach(button => {
        billingCodes.push(button.dataset.code);
    });

    // Auto-detect visit type from billing codes
    const wellVisitCodes = billingCodes.filter(code => WELL_VISIT_CODES.includes(code));
    const visitType = wellVisitCodes.length > 0 ? 'Well' : 'Sick';

    // Store as JSON array if multiple, single string if one
    const billingCode = billingCodes.length > 1 ? JSON.stringify(billingCodes) : (billingCodes[0] || '');

    const comments = document.getElementById('comments').value;

    // Collect custom fields
    const customFields = {};
    document.querySelectorAll('[id^="custom_"]').forEach(field => {
        if (field.value) {
            customFields[field.dataset.fieldName] = field.value;
        }
    });

    const visitData = {
        date: new Date().toISOString().split('T')[0],
        start_time: window.currentVisitData.startTime,
        end_time: window.currentVisitData.endTime,
        active_duration: window.currentVisitData.activeDuration,
        visit_type: visitType,
        billing_code: billingCode,
        comments: comments,
        custom_fields: customFields
    };

    const response = await fetch('/api/visit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(visitData)
    });

    if (response.ok) {
        // Show flash message
        showFlashMessage();

        // Reset form
        document.querySelectorAll('#billingCodesContainer .billing-btn.selected').forEach(button => {
            button.classList.remove('selected');
        });
        document.getElementById('comments').value = '';
        document.querySelectorAll('[id^="custom_"]').forEach(field => {
            field.value = '';
        });
        updateVisitTypeIndicator();

        // Reset timer display
        document.getElementById('timerDisplay').textContent = '00:00';

        // Hide visit form
        document.getElementById('visitForm').style.display = 'none';

        // Show start button again
        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('encounterInfo').innerHTML = '<span id="encounterLabel">Ready to start</span>';

        // Check if auto-start is enabled
        const autoStart = document.getElementById('autoStartToggle').checked;
        if (autoStart) {
            // Wait a moment then restart timer automatically
            setTimeout(() => {
                startTimer();
            }, 500);
        }
    } else {
        alert('Error saving visit. Please try again.');
    }
}

async function saveManualVisit() {
    const visitDate = document.getElementById('manualDate').value;
    const startTimeValue = document.getElementById('manualStartTime').value;
    const endTimeValue = document.getElementById('manualEndTime').value;
    const duration = parseInt(document.getElementById('manualDuration').value) || 0;
    const comments = document.getElementById('manualComments').value;

    // Build start_time and end_time ISO strings if provided
    let startTime = null;
    let endTime = null;

    if (visitDate && startTimeValue) {
        startTime = `${visitDate}T${startTimeValue}:00`;
    }

    if (visitDate && endTimeValue) {
        endTime = `${visitDate}T${endTimeValue}:00`;
    }

    // Collect selected billing codes
    const billingCodes = [];
    document.querySelectorAll('#manualBillingCodesContainer .billing-btn.selected').forEach(button => {
        billingCodes.push(button.dataset.code);
    });

    // Auto-detect visit type from billing codes
    const wellVisitCodes = billingCodes.filter(code => WELL_VISIT_CODES.includes(code));
    const visitType = wellVisitCodes.length > 0 ? 'Well' : 'Sick';

    const billingCode = billingCodes.length > 1 ? JSON.stringify(billingCodes) : (billingCodes[0] || '');

    // Collect custom fields
    const customFields = {};
    document.querySelectorAll('[id^="manual_custom_"]').forEach(field => {
        if (field.value) {
            customFields[field.dataset.fieldName] = field.value;
        }
    });

    const visitData = {
        date: visitDate || new Date().toISOString().split('T')[0],
        start_time: startTime,
        end_time: endTime,
        active_duration: duration * 60, // Convert minutes to seconds
        visit_type: visitType,
        billing_code: billingCode,
        comments: comments,
        custom_fields: customFields
    };

    const response = await fetch('/api/visit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(visitData)
    });

    if (response.ok) {
        // Show flash message
        showFlashMessage();

        // Reset manual form
        resetManualForm();
        showManualMessage('Visit saved successfully!', 'success');
    } else {
        showManualMessage('Error saving visit. Please try again.', 'error');
    }
}

function resetManualForm() {
    document.getElementById('manualDate').valueAsDate = new Date();
    document.getElementById('manualStartTime').value = '';
    document.getElementById('manualEndTime').value = '';
    document.getElementById('manualDuration').value = '';
    document.getElementById('manualComments').value = '';

    document.querySelectorAll('#manualBillingCodesContainer .billing-btn.selected').forEach(button => {
        button.classList.remove('selected');
    });

    document.querySelectorAll('[id^="manual_custom_"]').forEach(field => {
        field.value = '';
    });

    updateManualVisitTypeIndicator();
}

function showManualMessage(text, type) {
    const messageDiv = document.getElementById('manualMessage');
    messageDiv.className = type === 'success' ? 'alert alert-success' : 'alert alert-error';
    messageDiv.textContent = text;
    messageDiv.style.display = 'block';

    if (type === 'success') {
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 3000);
    }
}

function showFlashMessage() {
    const flash = document.getElementById('flashMessage');
    flash.style.display = 'block';

    // Scroll to top to show the message
    window.scrollTo({top: 0, behavior: 'smooth'});

    setTimeout(() => {
        flash.style.display = 'none';
    }, 3000);
}

// Bible verses for inspiration
const bibleVerses = [
    "Galatians 6:9 - \"And let us not grow weary of doing good, for in due season we will reap, if we do not give up.\"",
    "Colossians 3:23 - \"Whatever you do, work heartily, as for the Lord and not for men.\"",
    "Proverbs 16:3 - \"Commit your work to the Lord, and your plans will be established.\"",
    "1 Corinthians 15:58 - \"Therefore, my beloved brothers, be steadfast, immovable, always abounding in the work of the Lord, knowing that in the Lord your labor is not in vain.\"",
    "Proverbs 12:14 - \"From the fruit of his mouth a man is satisfied with good, and the work of a man's hand comes back to him.\"",
    "Ecclesiastes 9:10 - \"Whatever your hand finds to do, do it with your might, for there is no work or thought or knowledge or wisdom in Sheol, to which you are going.\"",
    "Psalm 90:17 - \"Let the favor of the Lord our God be upon us, and establish the work of our hands upon us; yes, establish the work of our hands!\"",
    "Proverbs 14:23 - \"In all toil there is profit, but mere talk tends only to poverty.\"",
    "2 Thessalonians 3:13 - \"As for you, brothers, do not grow weary in doing good.\"",
    "Ephesians 6:7-8 - \"Rendering service with a good will as to the Lord and not to man, knowing that whatever good anyone does, this he will receive back from the Lord.\"",
    "Proverbs 13:4 - \"The soul of the sluggard craves and gets nothing, while the soul of the diligent is richly supplied.\"",
    "1 Timothy 5:18 - \"For the Scripture says, 'You shall not muzzle an ox when it treads out the grain,' and, 'The laborer deserves his wages.'\"",
    "Proverbs 22:29 - \"Do you see a man skillful in his work? He will stand before kings; he will not stand before obscure men.\"",
    "Hebrews 6:10 - \"For God is not unjust so as to overlook your work and the love that you have shown for his name in serving the saints, as you still do.\"",
    "James 1:25 - \"But the one who looks into the perfect law, the law of liberty, and perseveres, being no hearer who forgets but a doer who acts, he will be blessed in his doing.\"",
    "Proverbs 10:4 - \"A slack hand causes poverty, but the hand of the diligent makes rich.\"",
    "Proverbs 21:5 - \"The plans of the diligent lead surely to abundance, but everyone who is hasty comes only to poverty.\"",
    "1 Corinthians 10:31 - \"So, whether you eat or drink, or whatever you do, do all to the glory of God.\"",
    "Philippians 2:14-15 - \"Do all things without grumbling or disputing, that you may be blameless and innocent, children of God without blemish in the midst of a crooked and twisted generation.\"",
    "Titus 3:14 - \"And let our people learn to devote themselves to good works, so as to help cases of urgent need, and not be unfruitful.\"",
    "Isaiah 26:3 - \"You keep him in perfect peace whose mind is stayed on you, because he trusts in you.\"",
    "Philippians 4:13 - \"I can do all things through him who strengthens me.\"",
    "Isaiah 41:10 - \"Fear not, for I am with you; be not dismayed, for I am your God; I will strengthen you, I will help you, I will uphold you with my righteous right hand.\"",
    "Jeremiah 29:11 - \"For I know the plans I have for you, declares the Lord, plans for welfare and not for evil, to give you a future and a hope.\"",
    "Romans 8:28 - \"And we know that for those who love God all things work together for good, for those who are called according to his purpose.\"",
    "Proverbs 3:5-6 - \"Trust in the Lord with all your heart, and do not lean on your own understanding. In all your ways acknowledge him, and he will make straight your paths.\"",
    "Psalm 46:1 - \"God is our refuge and strength, a very present help in trouble.\"",
    "2 Corinthians 12:9 - \"But he said to me, 'My grace is sufficient for you, for my power is made perfect in weakness.' Therefore I will boast all the more gladly of my weaknesses, so that the power of Christ may rest upon me.\"",
    "Joshua 1:9 - \"Have I not commanded you? Be strong and courageous. Do not be frightened, and do not be dismayed, for the Lord your God is with you wherever you go.\"",
    "Psalm 37:4 - \"Delight yourself in the Lord, and he will give you the desires of your heart.\"",
    "Matthew 11:28 - \"Come to me, all who labor and are heavy laden, and I will give you rest.\"",
    "Philippians 4:6-7 - \"Do not be anxious about anything, but in everything by prayer and supplication with thanksgiving let your requests be made known to God. And the peace of God, which surpasses all understanding, will guard your hearts and your minds in Christ Jesus.\"",
    "Romans 15:13 - \"May the God of hope fill you with all joy and peace in believing, so that by the power of the Holy Spirit you may abound in hope.\"",
    "Psalm 23:4 - \"Even though I walk through the valley of the shadow of death, I will fear no evil, for you are with me; your rod and your staff, they comfort me.\"",
    "1 Peter 5:7 - \"Casting all your anxieties on him, because he cares for you.\"",
    "Nahum 1:7 - \"The Lord is good, a stronghold in the day of trouble; he knows those who take refuge in him.\"",
    "Lamentations 3:22-23 - \"The steadfast love of the Lord never ceases; his mercies never come to an end; they are new every morning; great is your faithfulness.\"",
    "Psalm 55:22 - \"Cast your burden on the Lord, and he will sustain you; he will never permit the righteous to be moved.\"",
    "John 16:33 - \"I have said these things to you, that in me you may have peace. In the world you will have tribulation. But take heart; I have overcome the world.\"",
    "2 Timothy 1:7 - \"For God gave us a spirit not of fear but of power and love and self-control.\""
];

function displayRandomVerse() {
    const randomIndex = Math.floor(Math.random() * bibleVerses.length);
    const verseElement = document.getElementById('verseText');
    if (verseElement) {
        verseElement.textContent = bibleVerses[randomIndex];
    }
}

// Initialize
loadEncounterNumber();
loadBillingCodes();
loadManualBillingCodes();
loadCustomFields();
loadManualCustomFields();
displayRandomVerse();

// Set today's date as default for manual entry
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('manualDate').valueAsDate = new Date();
});
</script>

<style>
@keyframes slideDown {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}
</style>
{% endblock %}
