{% extends "base.html" %}

{% block title %}Daily Summary - Clinic Visit Tracker{% endblock %}
{% block nav_daily %}active{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>Daily Summary</h1>
    <div style="display: flex; gap: 1rem; align-items: center;">
        <input type="date" id="dateSelector" value="{{ date }}" onchange="changeDate()"
               style="background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: 8px;">
        <button class="btn btn-secondary" onclick="toggleMoneyDisplay()" id="moneyToggle">
            Show $ Values
        </button>
    </div>
</div>

<!-- Bible Verse Banner -->
<div id="verseBanner" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border-radius: 8px; padding: 1rem 1.5rem; margin-bottom: 1.5rem; font-style: italic; color: var(--text-secondary);">
    <div id="verseText" style="font-size: 1rem; line-height: 1.6;"></div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Visits</div>
        <div class="stat-value">{{ stats.total_visits }}</div>
    </div>

    <div class="stat-card">
        <div class="stat-label">Average Duration</div>
        <div class="stat-value">{{ (stats.avg_duration / 60) | round(1) }} min</div>
    </div>

    <div class="stat-card">
        <div class="stat-label">Total Time</div>
        <div class="stat-value">{{ (stats.total_duration / 60) | round(1) }} min</div>
    </div>

    <div class="stat-card">
        <div class="stat-label">Total wRVU</div>
        <div class="stat-value">{{ stats.total_wrvu | round(2) }}</div>
    </div>

    <div class="stat-card">
        <div class="stat-label">Average wRVU</div>
        <div class="stat-value">{{ stats.avg_wrvu | round(2) }}</div>
    </div>

    <div class="stat-card money-value">
        <div class="stat-label">Total Value</div>
        <div class="stat-value" id="totalValue">***</div>
    </div>
</div>

<!-- Visit Type Breakdown -->
{% if stats.visit_types %}
<div class="stat-card">
    <div class="stat-label">Visit Types</div>
    <div class="stat-breakdown">
        {% for vtype, count in stats.visit_types.items() %}
        <div class="stat-breakdown-item">
            <span>{{ vtype }}</span>
            <span><strong>{{ count }}</strong> visits
                {% if stats.avg_by_type and vtype in stats.avg_by_type %}
                (avg: {{ (stats.avg_by_type[vtype] / 60) | round(1) }} min)
                {% endif %}
            </span>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Billing Codes Breakdown -->
{% if stats.billing_codes %}
<div class="stat-card">
    <div class="stat-label">Billing Codes</div>
    <div class="stat-breakdown">
        {% for code, count in stats.billing_codes.items() %}
        <div class="stat-breakdown-item">
            <span>{{ code }}</span>
            <span><strong>{{ count }}</strong></span>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Custom Field Statistics -->
{% if stats.custom_field_stats %}
{% for field_name, field_values in stats.custom_field_stats.items() %}
<div class="stat-card">
    <div class="stat-label">{{ field_name }}</div>
    <div class="stat-breakdown">
        {% for value, count in field_values.items() %}
        <div class="stat-breakdown-item">
            <span>{{ value }}</span>
            <span><strong>{{ count }}</strong></span>
        </div>
        {% endfor %}
    </div>
</div>
{% endfor %}
{% endif %}

<!-- Visits Table -->
{% if visits %}
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Encounter</th>
                <th>Day</th>
                <th>Start Time</th>
                <th>Duration</th>
                <th>Visit Type</th>
                <th>Billing Code</th>
                <th>wRVU</th>
                <th>Comments</th>
                {% for field in custom_fields %}
                <th>{{ field.field_name }}</th>
                {% endfor %}
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for visit in visits %}
            <tr id="visit-{{ visit.id }}">
                <td>#{{ loop.revindex }}</td>
                <td>{{ visit.day_of_week or '-' }}</td>
                <td>{{ visit.start_time.split('T')[1][:5] if 'T' in visit.start_time else visit.start_time }}</td>
                <td>{{ format_duration(visit.active_duration) }}</td>
                <td>{{ visit.visit_type or '-' }}</td>
                <td>{{ visit.billing_code or '-' }}</td>
                <td>{{ visit.billing_code | calc_wrvu | round(2) if visit.billing_code else '-' }}</td>
                <td>{{ visit.comments or '-' }}</td>
                {% for field in custom_fields %}
                <td>{{ visit.custom_fields.get(field.field_name, '-') }}</td>
                {% endfor %}
                <td>
                    <button class="btn btn-danger" onclick="deleteVisit({{ visit.id }})"
                            style="padding: 0.5rem 1rem; font-size: 0.9rem;">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center" style="padding: 3rem;">
    <p class="text-muted" style="font-size: 1.2rem;">No visits recorded for this date</p>
</div>
{% endif %}

<script>
// Stats data from server
const stats = {
    totalWrvu: {{ stats.total_wrvu }},
    avgWrvu: {{ stats.avg_wrvu }}
};

let conversionRate = 36.00;
let moneyVisible = false;

// Load conversion rate
async function loadConversionRate() {
    const response = await fetch('/api/wrvu-conversion-rate');
    const data = await response.json();
    conversionRate = data.rate;
}

function toggleMoneyDisplay() {
    moneyVisible = !moneyVisible;
    const toggleBtn = document.getElementById('moneyToggle');
    const totalValueEl = document.getElementById('totalValue');

    if (moneyVisible) {
        const totalValue = stats.totalWrvu * conversionRate;
        totalValueEl.textContent = '$' + totalValue.toFixed(2);
        toggleBtn.textContent = 'Hide $ Values';
        toggleBtn.classList.remove('btn-secondary');
        toggleBtn.classList.add('btn-primary');
    } else {
        totalValueEl.textContent = '***';
        toggleBtn.textContent = 'Show $ Values';
        toggleBtn.classList.remove('btn-primary');
        toggleBtn.classList.add('btn-secondary');
    }
}

function changeDate() {
    const date = document.getElementById('dateSelector').value;
    window.location.href = `/daily-summary?date=${date}`;
}

async function deleteVisit(visitId) {
    if (!confirm('Are you sure you want to delete this visit?')) {
        return;
    }

    const response = await fetch(`/api/visit/${visitId}`, {
        method: 'DELETE'
    });

    if (response.ok) {
        location.reload();
    } else {
        alert('Error deleting visit. Please try again.');
    }
}

// Bible verses for inspiration
const bibleVerses = [
    "Galatians 6:9 - \"And let us not grow weary of doing good, for in due season we will reap, if we do not give up.\"",
    "Colossians 3:23 - \"Whatever you do, work heartily, as for the Lord and not for men.\"",
    "Proverbs 16:3 - \"Commit your work to the Lord, and your plans will be established.\"",
    "1 Corinthians 15:58 - \"Therefore, my beloved brothers, be steadfast, immovable, always abounding in the work of the Lord, knowing that in the Lord your labor is not in vain.\"",
    "Proverbs 12:14 - \"From the fruit of his mouth a man is satisfied with good, and the work of a man's hand comes back to him.\"",
    "Ecclesiastes 9:10 - \"Whatever your hand finds to do, do it with your might, for there is no work or thought or knowledge or wisdom in Sheol, to which you are going.\"",
    "Psalm 90:17 - \"Let the favor of the Lord our God be upon us, and establish the work of our hands upon us; yes, establish the work of our hands!\"",
    "Proverbs 14:23 - \"In all toil there is profit, but mere talk tends only to poverty.\"",
    "2 Thessalonians 3:13 - \"As for you, brothers, do not grow weary in doing good.\"",
    "Ephesians 6:7-8 - \"Rendering service with a good will as to the Lord and not to man, knowing that whatever good anyone does, this he will receive back from the Lord.\"",
    "Proverbs 13:4 - \"The soul of the sluggard craves and gets nothing, while the soul of the diligent is richly supplied.\"",
    "1 Timothy 5:18 - \"For the Scripture says, 'You shall not muzzle an ox when it treads out the grain,' and, 'The laborer deserves his wages.'\"",
    "Proverbs 22:29 - \"Do you see a man skillful in his work? He will stand before kings; he will not stand before obscure men.\"",
    "Hebrews 6:10 - \"For God is not unjust so as to overlook your work and the love that you have shown for his name in serving the saints, as you still do.\"",
    "James 1:25 - \"But the one who looks into the perfect law, the law of liberty, and perseveres, being no hearer who forgets but a doer who acts, he will be blessed in his doing.\"",
    "Proverbs 10:4 - \"A slack hand causes poverty, but the hand of the diligent makes rich.\"",
    "Proverbs 21:5 - \"The plans of the diligent lead surely to abundance, but everyone who is hasty comes only to poverty.\"",
    "1 Corinthians 10:31 - \"So, whether you eat or drink, or whatever you do, do all to the glory of God.\"",
    "Philippians 2:14-15 - \"Do all things without grumbling or disputing, that you may be blameless and innocent, children of God without blemish in the midst of a crooked and twisted generation.\"",
    "Titus 3:14 - \"And let our people learn to devote themselves to good works, so as to help cases of urgent need, and not be unfruitful.\"",
    "Isaiah 26:3 - \"You keep him in perfect peace whose mind is stayed on you, because he trusts in you.\"",
    "Philippians 4:13 - \"I can do all things through him who strengthens me.\"",
    "Isaiah 41:10 - \"Fear not, for I am with you; be not dismayed, for I am your God; I will strengthen you, I will help you, I will uphold you with my righteous right hand.\"",
    "Jeremiah 29:11 - \"For I know the plans I have for you, declares the Lord, plans for welfare and not for evil, to give you a future and a hope.\"",
    "Romans 8:28 - \"And we know that for those who love God all things work together for good, for those who are called according to his purpose.\"",
    "Proverbs 3:5-6 - \"Trust in the Lord with all your heart, and do not lean on your own understanding. In all your ways acknowledge him, and he will make straight your paths.\"",
    "Psalm 46:1 - \"God is our refuge and strength, a very present help in trouble.\"",
    "2 Corinthians 12:9 - \"But he said to me, 'My grace is sufficient for you, for my power is made perfect in weakness.' Therefore I will boast all the more gladly of my weaknesses, so that the power of Christ may rest upon me.\"",
    "Joshua 1:9 - \"Have I not commanded you? Be strong and courageous. Do not be frightened, and do not be dismayed, for the Lord your God is with you wherever you go.\"",
    "Psalm 37:4 - \"Delight yourself in the Lord, and he will give you the desires of your heart.\"",
    "Matthew 11:28 - \"Come to me, all who labor and are heavy laden, and I will give you rest.\"",
    "Philippians 4:6-7 - \"Do not be anxious about anything, but in everything by prayer and supplication with thanksgiving let your requests be made known to God. And the peace of God, which surpasses all understanding, will guard your hearts and your minds in Christ Jesus.\"",
    "Romans 15:13 - \"May the God of hope fill you with all joy and peace in believing, so that by the power of the Holy Spirit you may abound in hope.\"",
    "Psalm 23:4 - \"Even though I walk through the valley of the shadow of death, I will fear no evil, for you are with me; your rod and your staff, they comfort me.\"",
    "1 Peter 5:7 - \"Casting all your anxieties on him, because he cares for you.\"",
    "Nahum 1:7 - \"The Lord is good, a stronghold in the day of trouble; he knows those who take refuge in him.\"",
    "Lamentations 3:22-23 - \"The steadfast love of the Lord never ceases; his mercies never come to an end; they are new every morning; great is your faithfulness.\"",
    "Psalm 55:22 - \"Cast your burden on the Lord, and he will sustain you; he will never permit the righteous to be moved.\"",
    "John 16:33 - \"I have said these things to you, that in me you may have peace. In the world you will have tribulation. But take heart; I have overcome the world.\"",
    "2 Timothy 1:7 - \"For God gave us a spirit not of fear but of power and love and self-control.\""
];

function displayRandomVerse() {
    const randomIndex = Math.floor(Math.random() * bibleVerses.length);
    const verseElement = document.getElementById('verseText');
    if (verseElement) {
        verseElement.textContent = bibleVerses[randomIndex];
    }
}

// Initialize
loadConversionRate();
displayRandomVerse();
</script>
{% endblock %}
